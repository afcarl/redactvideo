<!DOCTYPE HTML>
<html>
<head>
    <title>RedactVideo</title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>
    <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/cerulean/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/4.0.1/min/dropzone.min.css"/>
    <script type="text/javascript" src="https://rawgit.com/allensarkisyan/VideoFrame/master/VideoFrame.js"/></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/4.0.1/min/dropzone.min.js"></script>
    <script>
window.redaction_colors = ['Lime', 'DarkGoldenRod', 'DarkKhaki', 'LightPink', 'Green', 'DarkBlue', 'FireBrick', 'LightSkyBlue', 'Red', 'SpringGreen', 'Beige', 'Maroon', 'GhostWhite', 'LawnGreen', 'White', 'Orchid', 'DarkSlateBlue', 'OliveDrab', 'DarkSeaGreen', 'MediumPurple', 'Tan', 'MediumAquaMarine', 'Pink', 'SeaGreen', 'FloralWhite', 'CornflowerBlue', 'LightSteelBlue', 'Brown', 'Silver', 'Teal', 'MediumVioletRed', 'DarkMagenta', 'Fuchsia', 'DimGray', 'IndianRed', 'MediumBlue', 'MintCream', 'HotPink', 'DarkSlateGray', 'SeaShell', 'CadetBlue', 'HoneyDew', 'Indigo', 'Coral', 'Cyan', 'Orange', 'LightGreen', 'Linen', 'LemonChiffon', 'Blue', 'DarkSalmon', 'Aqua', 'LightCoral', 'Purple', 'PaleGoldenRod', 'Magenta', 'LightGoldenRodYellow', 'Violet', 'DarkRed', 'Gold', 'DodgerBlue', 'Cornsilk', 'Chocolate', 'SlateBlue', 'DeepPink', 'PaleVioletRed', 'Black', 'RebeccaPurple', 'Snow', 'Moccasin', 'DarkGreen', 'GoldenRod', 'Salmon', 'LightSlateGray', 'OldLace', 'DarkOrange', 'Aquamarine', 'LightGray', 'Gainsboro', 'LightSeaGreen', 'Yellow', 'Turquoise', 'DarkCyan', 'LightSalmon', 'DarkGray', 'SlateGray', 'BlueViolet', 'MediumOrchid', 'Olive', 'PowderBlue', 'YellowGreen', 'Thistle', 'ForestGreen', 'MidnightBlue', 'Lavender', 'Azure', 'MediumSpringGreen', 'Chartreuse', 'MediumSlateBlue', 'Sienna', 'SaddleBrown', 'Wheat', 'AntiqueWhite', 'RoyalBlue', 'SandyBrown', 'NavajoWhite', 'AliceBlue', 'Bisque', 'PapayaWhip', 'DeepSkyBlue', 'SteelBlue', 'Gray', 'LavenderBlush', 'PeachPuff', 'Navy', 'LightYellow', 'LimeGreen', 'Crimson', 'OrangeRed', 'DarkViolet', 'RosyBrown', 'LightCyan', 'PaleTurquoise', 'SkyBlue', 'Khaki', 'DarkTurquoise', 'LightBlue', 'BlanchedAlmond', 'Plum', 'MediumSeaGreen', 'DarkOrchid', 'Tomato', 'WhiteSmoke', 'MediumTurquoise', 'MistyRose', 'GreenYellow', 'Ivory', 'PaleGreen', 'DarkOliveGreen', 'Peru', 'BurlyWood'];
window.redaction_n = -1;
window.audio_redaction_state = 'start';
window.status = {}
window.mode = 'none';
window.resizeId = '';
window.current_video = '';
window.frame_redactions = {0: {}};
window.redactionIdToColor = {};
function pad(n, width, z) {
    z = z || '0';
    n = n + '';
    return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
}

function makeid() {
    var text = "";
    var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

    for (var i = 0; i < 5; i++)
        text += possible.charAt(Math.floor(Math.random() * possible.length));

    return text;
}

function selectContainer(containerName) {
    // hide all containers except the nav one
    $('.container').not('nav .container').hide();
    // show the clicked on container
    $('#' + containerName + '_container').show();
    // remove active class from currently active link
    $('.active').removeClass("active");
    // make the clicked on link's parent li active
    var theLink = $("a[href^='#" + containerName + "']")
    theLink.parent().addClass("active");
}
$(function() {
    var socket = io.connect('http://' + document.domain + ':' + location.port + '/test');
    socket.on('connect', function() {
        console.log('connected');
        socket.emit('my event', {
            data: 'I\'m connected!'
        });
    });
    socket.on('my response', function(msg) {
        console.log('<p>Received: ' + msg.data + '</p>');
    });
    socket.on('redaction_video_id', function(msg) {
        window.redaction_video_id = msg.data;
        console.log('Redaction video id: ' + msg.data + '</p>');
    });
    socket.on('framization_status', function(msg) {
        console.log(msg.data);
        $('#framization_status').text(msg.data);
    });
    socket.on('track_result', function(msg) {
        console.log(msg);
        var coordict = {};
        coordict[msg['box_id']] = msg['coordinates'];
        console.log('coordict '+coordict);
        frame = msg['frame'];
        if (frame in window.frame_redactions) {
            window.frame_redactions[parseInt(msg['frame'])][msg['box_id']] = msg['coordinates'];
        } else {
            window.frame_redactions[parseInt(msg['frame'])] = coordict;
        }
    });
    // hide all containers except the nav one
    $('.container').not('nav .container').hide();
    if (window.location.hash) {
        var theHash = window.location.hash.slice(1);
        selectContainer(theHash);
    } else {
        var defaultContainerName = 'upload_videos';
        selectContainer(defaultContainerName);
    }
    $('#request_an_account').click(function() {
        $.post('/submit_request_for_account/', {
            'agency_email': $('#agency_email').val()
        }, function(data) {
            $('#request_account_form').text("Request sent. You'll receive an email when your account is created.");
        });
    });
    $("nav a[href^='#']").click(function(e) {
        var containerName = $(this).attr('href').slice(1);
        selectContainer(containerName);

    });
    // a method for getting an associative array of input field values
    $.fn.form = function() {
        var formData = {};
        this.find('[name]').each(function() {
            formData[this.name] = this.value;
        })
        return formData;
    };
    $('.save').click(function() {
        var inputFields = $(this).parent().form();
        window.saveButton = $(this);
        $.post('/change_site_settings/', inputFields, function(data) {
            //console.log('updated');
            window.saveButton.next("span").text('Settings updated.');
        });
    });
    $('.save_user_settings').click(function() {
        var inputFields = $(this).parent().form();
        window.saveButton = $(this);
        $.post('/change_user_settings/', inputFields, function(data) {
            //console.log('updated');
            window.saveButton.next("span").text('Settings updated.');
        });
    });
    $('#overblur_and_publish_all_videos').click(function() {
        $('#overblur_and_publish_all_videos').next().text('Processing');
        $.get('/overblur_and_publish_all_videos/', function(data) {
            $('#overblur_and_publish_all_videos').next().text('Done');
        });
    });
    Dropzone.options.dropzone = {
        maxFilesize: 5000
    }
    function getFrameCoords(frame) {
        console.log(frame, Object.keys(window.frame_redactions), window.frame_redactions[frame]);
        frame = parseInt(frame);
        $('.finished_rectangle').hide();
        $('.resize').hide();
        if (frame in window.frame_redactions) {
            boxes = Object.keys(window.frame_redactions[frame]);
            jQuery.each( boxes, function( i, val ) {
                if ($('#'+val).length) {
                
                    
                    
                } else {
                    $('#video_player_canvas').append('<div class="finished_rectangle" id="'+val+'" style="border-color:'+window.redactionIdToColor[val]+'"></div>');
                }
                $('#'+val).show();
                var coord = window.frame_redactions[frame][val];
                $('#'+val).css('left', coord[0]);
                $('#'+val).css('top', coord[1]);
                $('#'+val).css('width', coord[2]);
                $('#'+val).css('height', coord[3]);
                $('#'+val).attr('title', JSON.stringify(coord));
                
                $('#top_left_for_'+val).show();
                $('#top_right_for_'+val).show();
                $('#bottom_right_for_'+val).show();
                $('#bottom_left_for_'+val).show();
            });
            //window.frame_redactions[frame];
        }
        
        window.currentFrame.html(frame);
    }
    $('#list_of_videos a').click(function(e) {
        window.redaction_n = -1;
        userid = "{{ userid }}";
        socket.emit('framize', {data: userid+'/'+$(this).attr('href').slice(1)});
        hash = $(this).attr('data-hash');
        window.current_video = userid+'/'+$(this).attr('href').slice(1);
        url = 'https://s3-us-west-2.amazonaws.com/redactvideodotorg/' + userid + '/' + $(this).attr('href').slice(1);
        redactionOptions = '<div id="redaction_options">';
        redactionOptions += '<p>What do you want to do?</p>';
        redactionOptions += '<ul>';
        redactionOptions += '<li><a href="#track_forwards_and_backwards">Track forwards and backwards</a></li>';
        redactionOptions += '<li><a href="#track_forwards">Track forwards</a></li>';
        redactionOptions += '<li><a href="#track_backwards">Track backwards</a></li>';
        redactionOptions += '<li><a href="#redact_for_time_period">Redact for time period</a></li>';
        redactionOptions += '<li><a href="#redact_for_entire_video">Redact for entire video</a></li>';
        redactionOptions += '</ul>';

        redactionOptions += '</div>';
        html = '<div id="video_player_canvas">' + redactionOptions + '</div><video id="video_player" controls>';
        html += '  <source src="' + url + '">';
        html += 'Your browser does not support the video tag.';
        html += '</video>  <div id="controls"><div class="frame"><p id="framization_status"></p><span id="currentFrame">0</span></div><input type="button" value="Play/Pause" id="play-pause" /><input type="button" value="Start point for audio redaction" id="start-stop-audio-redact" /></div><h3>Video redactions</h3><table id="video_redaction_table"><tr><th>Color</th><th>Center</th><th>Start</th><th>Stop</th></tr></table><h3>Audio redactions</h3><table id="audio_redaction_table"><tr><th></th><th>Start</th><th>Stop</th></table>';
        $('#video_player_for_manage_videos').html(html);
        setTimeout(function() {
            console.log('inner height ' + $('#video_player').innerHeight() + ' ' + $('#video_player').height() + ' ' + $('#video_player').innerWidth() + ' ' + $('#video_player').width());

            $('#video_player_for_manage_videos').height($('#video_player').height());
            $('#video_player_for_manage_videos').width($('#video_player').width());
            console.log('inner height ' + $('#video_player').innerHeight() + ' ' + $('#video_player').height() + ' ' + $('#video_player').innerWidth() + ' ' + $('#video_player').width());

            console.log($('#video_player_for_manage_videos').width());
            $('#video_player_canvas').height($('#video_player').innerHeight() - 50);
            $('#video_player_canvas').width($('#video_player').innerWidth());
        }, 2000);
        $('#video_player_for_manage_videos').html(html);
        window.currentFrame = $('#currentFrame');
        window.video = VideoFrame({
            id: 'video_player',
            //frameRate: 24.25,
            frameRate: 29.97,
            callback: function(frame) {
                getFrameCoords(frame);
            }
        });
        $("#video_player")[0].onplay = function ()  {
            console.debug("Video playing");
            //window.video.stopListen();
            window.video.listen('frame');
        };
        $("#video_player")[0].onseeked = function () {
            window.video.listen('frame');
        };
        $("#video_player")[0].onseeking = function () {
            getFrameCoords(window.video.get());
        };
        $("#video_player")[0].onpause = function ()  {
            console.debug("Video paused");
            //window.video.stopListen();
            getFrameCoords(window.video.get());
        };
        setTimeout(function() {
            for (var i = 1; i < ($('#video_player').get(0).duration / 30); i++) {
                //$('#video_player_for_manage_videos').append('<img class="thumb" src="https://s3-us-west-2.amazonaws.com/redactvideodotorg/'+hash+'/'+pad(i, 3)+'.jpg" />');
                $('#video_player_for_manage_videos').append('<div class="thumb" onclick=\'$("#video_player").get(0).currentTime = ' + (i * 30 - 30) + ';$("#video_player").get(0).play();$("body").scrollTop("#video_player");\' style="background-image:url(https://s3-us-west-2.amazonaws.com/redactvideodotorg/' + hash + '/' + pad(i, 3) + '.jpg)" type="image/jpeg"></div>');

            }


        }, 1000);
        e.preventDefault();
    });


    $('body').on('click', '#play-pause', function() {
        console.log(JSON.stringify(window.video));

        if ($('#video_player').get(0).paused) {
            $('#video_player').get(0).play();
            window.video.listen('frame');
            $(this).val('Pause');
        } else {
            $('#video_player').get(0).pause();
            window.video.stopListen();
            $(this).val('Play');
        }
    });
    
    

    function setMousePosition(e) {
        var offset = e.target.offset();
        mouse.x = event.pageX - offset.left;
        mouse.y = event.pageY - offset.top;

    };
    var mouse = {
        x: 0,
        y: 0,
        startX: 0,
        startY: 0
    };
    var element = null;
    $('body').on('mousemove', '#video_player_canvas', function(e) {
        if (mode == 'none') {
            //setMousePosition(e);
            var offset = $(this).offset();
            mouse.x = event.pageX - offset.left;
            mouse.y = event.pageY - offset.top;
            if (element !== null) {
                element.style.width = Math.abs(mouse.x - mouse.startX) + 'px';
                element.style.height = Math.abs(mouse.y - mouse.startY) + 'px';
                element.style.left = (mouse.x - mouse.startX < 0) ? mouse.x + 'px' : mouse.startX + 'px';
                element.style.top = (mouse.y - mouse.startY < 0) ? mouse.y + 'px' : mouse.startY + 'px';
            }
        } else if (mode == 'resize') {
            //setMousePosition(e);
            var offset = $(this).offset();
            mouse.x = event.pageX - offset.left;
            mouse.y = event.pageY - offset.top;
            element = document.getElementById(window.resizeId);
            if (element !== null) {
                 
                // I have a hard time wrapping my head around the math for this
                // below works if window.x == 'left' and window.y == 'top' and mouse.x > mouse.startX
                console.log('TRUTH:');
                a = (window.x == 'right');
                b = (window.y == 'bottom');
                c = (mouse.x > (mouse.startX + mouse.width));
                d = (mouse.y > (mouse.startY + mouse.height));
                
                console.log(a + ' ' + b + ' ' + c + ' ' + d); 
                console.log(window.x + ' ' + window.y);
                
                //console.log((window.x == 'right') + (window.y == 'top') + (mouse.x > (mouse.startX + mouse.width)) + (mouse.y > (mouse.startY + mouse.height)));
                console.log(mouse.x + ' ' + (mouse.startX + mouse.width) + ' ' + mouse.y + ' ' + (mouse.startY + mouse.height));
                if (window.x == 'left' && window.y == 'top' && mouse.x <= mouse.startX && mouse.y <= mouse.startY) {
                    element.style.width = mouse.width + Math.abs(mouse.x - mouse.startX) + 'px';
                    element.style.height = mouse.height + Math.abs(mouse.y - mouse.startY) + 'px';
                    element.style.left = mouse.x + 'px';
                    element.style.top = mouse.y + 'px';
                } else if (window.x == 'left' && window.y == 'top' && mouse.x > mouse.startX && mouse.y > mouse.startY) {
                    element.style.width = mouse.width - Math.abs(mouse.startX - mouse.x) + 'px';
                    element.style.height = mouse.height - Math.abs(mouse.startY - mouse.y) + 'px';
                    element.style.left = mouse.x + 'px';
                    element.style.top = mouse.y + 'px';
                } else if (window.x == 'right' && window.y == 'top' && mouse.x > (mouse.startX + mouse.width) && mouse.y < (mouse.startY + mouse.height)) {
                    element.style.width = mouse.width + Math.abs((mouse.startX + mouse.width) - mouse.x) + 'px';
                    element.style.height = mouse.height + Math.abs(mouse.y - mouse.startY) + 'px';
                    element.style.left = mouse.startX + 'px';
                    element.style.top = mouse.y + 'px';
                } else if (window.x == 'right' && window.y == 'top' && mouse.x < (mouse.startX + mouse.width) && mouse.y < (mouse.startY + mouse.height)) {
                    element.style.width = Math.abs((mouse.startX + mouse.width) - mouse.x) + 'px';
                    element.style.height = mouse.height + Math.abs(mouse.y - mouse.startY) + 'px';
                    element.style.left = mouse.startX + 'px';
                    element.style.top = mouse.y + 'px';
                } else if (window.x == 'right' && window.y == 'bottom' && mouse.x > (mouse.startX + mouse.width) && mouse.y > (mouse.startY + mouse.height)) {
                    
                    element.style.width = mouse.width + Math.abs(mouse.x - (mouse.startX + mouse.width)) + 'px';
                    element.style.height = mouse.height + Math.abs(mouse.y - (mouse.startY + mouse.height)) + 'px';
                    element.style.left = mouse.startX + 'px';
                    element.style.top = mouse.startY + 'px';
                } else if (window.x == 'right' && window.y == 'bottom' && mouse.x < (mouse.startX + mouse.width) && mouse.y < (mouse.startY + mouse.height)) {
                    element.style.width = mouse.width - Math.abs((mouse.startX + mouse.width) - mouse.x) + 'px';
                    element.style.height = mouse.height - Math.abs((mouse.startY + mouse.height) - mouse.y) + 'px';
                    element.style.left = mouse.startX + 'px';
                    element.style.top = mouse.startY + 'px';
                } else if (window.x == 'left' && window.y == 'bottom' && mouse.x < mouse.startX && mouse.y > mouse.startY) {
                    
                    element.style.width = mouse.width + Math.abs((mouse.startX - mouse.x)) + 'px';
                    element.style.height = mouse.height + Math.abs(mouse.y - (mouse.startY + mouse.height)) + 'px';
                    element.style.left = mouse.x + 'px';
                    element.style.top = mouse.startY + 'px';
                } else if (window.x == 'left' && window.y == 'bottom' && mouse.x > mouse.startX && mouse.y < (mouse.startY + mouse.height)) {
                    element.style.width = mouse.width - Math.abs((mouse.x - mouse.startX)) + 'px';
                    element.style.height = mouse.height - Math.abs((mouse.startY + mouse.height) - mouse.y) + 'px';
                    element.style.left = mouse.x + 'px';
                    element.style.top = mouse.startY + 'px';
                }
                var top = parseFloat(element.style.top.slice(0, -2));
                var left = parseFloat(element.style.left.slice(0, -2));
                var width = parseFloat(element.style.width.slice(0, -2));
                var height = $('#' + element.id).height();
                console.log('top: ' + top + ' left: ' + left + ' width: ' + width + ' height: ' + height);
                console.log('color ', element.style.borderColor);
                window.redactionIdToColor[element.id] = element.style.borderColor;
                var color = element.style.borderColor;
                console.log(parseFloat(element.style.left.slice(0, -2)), element.style.left);
                // top left
                $('#top_left_for_' + element.id).css({'top': (top - 3) + 'px', 'left': (left - 3) + 'px'});
                // top right
                $('#top_right_for_' + element.id).css({'top': (top - 3) + 'px', 'left': (left + width - 3) + 'px'});
                // bottom right
                $('#bottom_right_for_' + element.id).css({'top': (top + height - 3) + 'px', 'left': (left + width - 3) + 'px'});
                
                // bottom left
                $('#bottom_left_for_' + element.id).css({'top': (top + height - 3) + 'px', 'left': (left - 3) + 'px'});
                
            }
        }
    });

    function addEndPoints(element) {
        var top = parseFloat(element.style.top.slice(0, -2));
        var left = parseFloat(element.style.left.slice(0, -2));
        var width = parseFloat(element.style.width.slice(0, -2));
        var height = $('#' + element.id).height();
        console.log('top: ' + top + ' left: ' + left + ' width: ' + width + ' height: ' + height);
        console.log('color ', element.style.borderColor);
        window.redactionIdToColor[element.id] = element.style.borderColor;
        var color = element.style.borderColor;
        console.log(parseFloat(element.style.left.slice(0, -2)), element.style.left);
        // top left
        $('#video_player_canvas').append('<div id="top_left_for_' + element.id + '" data-x="left" data-y="top" data-box-id="' + element.id + '" class="top_left resize" style="top:' + (top - 3) + 'px;left:' + (left - 3) + 'px;position:absolute;height:6px;width:6px;background:' + color + ';"></div>');
        // top right
        $('#video_player_canvas').append('<div id="top_right_for_' + element.id + '" data-x="right" data-y="top" data-box-id="' + element.id + '" class="top_right resize" style="top:' + (top - 3) + 'px;left:' + (left + width - 3) + 'px;position:absolute;height:6px;width:6px;background:' + color + ';"></div>');

        // bottom right
        $('#video_player_canvas').append('<div id="bottom_right_for_' + element.id + '" data-x="right" data-y="bottom" data-box-id="' + element.id + '" class="bottom_right resize" style="top:' + (top + height - 3) + 'px;left:' + (left + width - 3) + 'px;position:absolute;height:6px;width:6px;background:' + color + ';"></div>');

        // bottom left
        $('#video_player_canvas').append('<div id="bottom_left_for_' + element.id + '" data-x="left" data-y="bottom" data-box-id="' + element.id + '" class="bottom_left resize" style="top:' + (top + height - 3) + 'px;left:' + (left - 3) + 'px;position:absolute;height:6px;width:6px;background:' + color + ';"></div>');

    }
    $('body').on('click', '.resize', function(e) {
        
        e.stopImmediatePropagation();
        e.stopPropagation();
        if (window.mode != 'resize') {
            window.x = $(this).attr('data-x');
            window.y = $(this).attr('data-y');
            console.log('clicked resize');
            window.mode = 'resize';
            window.resizeId = $(this).attr('data-box-id');
            console.log('THE RESIZE ID: ' + window.resizeId);
            mouse.startX = $('#' + window.resizeId).position().left;
            mouse.height = $('#' + window.resizeId).height();
            mouse.width = $('#' + window.resizeId).width();
            mouse.startY = $('#' + window.resizeId).position().top;
        } else {
            mode = 'none';
            
            e.stopImmediatePropagation();
            e.stopPropagation();
            var top = parseFloat(element.style.top.slice(0, -2));
            var left = parseFloat(element.style.left.slice(0, -2));
            var width = parseFloat(element.style.width.slice(0, -2));
            var height = $('#' + element.id).height();
            console.log('top: ' + top + ' left: ' + left + ' width: ' + width + ' height: ' + height);
            console.log('color ', element.style.borderColor);
            window.redactionIdToColor[element.id] = element.style.borderColor;
            var color = element.style.borderColor;
            console.log(parseFloat(element.style.left.slice(0, -2)), element.style.left);
            // top left
            $('#top_left_for_' + element.id).css({'top': (top - 3) + 'px', 'left': (left - 3) + 'px'});
            // top right
            $('#top_right_for_' + element.id).css({'top': (top - 3) + 'px', 'left': (left + width - 3) + 'px'});
            // bottom right
            $('#bottom_right_for_' + element.id).css({'top': (top + height - 3) + 'px', 'left': (left + width - 3) + 'px'});
            
            // bottom left
            $('#bottom_left_for_' + element.id).css({'top': (top + height - 3) + 'px', 'left': (left - 3) + 'px'});
            ele = $('#'+element.id);
            var coordict = {};
            var thecoords = [ Math.round(ele.position().left), Math.round(ele.position().top), Math.round(ele.width()), Math.round(ele.height())];
            coordict[element.id] = thecoords;
            if (frame in window.frame_redactions) {
                window.frame_redactions[parseInt(frame)][element.id] = thecoords;
            } else {
                window.frame_redactions[parseInt(frame)] = coordict;
            }
            element = null;
        }
    }); 
    $('body').on('click', '.delete_for_just_this_frame', function(e) {
        var id = $(this).parent().attr('id');
        $(this).parent().remove();
        e.stopImmediatePropagation();
        e.stopPropagation();
        $('#top_left_for_'+id).remove();
        $('#top_right_for_'+id).remove();
        $('#bottom_right_for_'+id).remove();
        $('#bottom_left_for_'+id).remove();
        console.log('current video '+window.video.get()+' '+window.frame_redactions[window.video.get()]);
        delete window.frame_redactions[window.video.get()][id];
        
    });
    $('body').on('click', '#video_player_canvas', function(e) {
        if (mode == 'none') {
            $('#video_player').get(0).pause();
            console.log('canvas onclick fired');
            if (element !== null) {
                element.className = 'finished_rectangle';
                $('#'+element.id).append('<input type="button" class="delete_for_all_frames" value="Del for all frames" />');
                $('#'+element.id).append('<input type="button" class="delete_for_some_frames" value="Del for some frames" />');
                $('#'+element.id).append('<input type="button" class="delete_for_just_this_frame" value="Del for just this frame" />');
                frame = window.video.get();
                ele = $('#'+element.id);
                var coordict = {};
                var thecoords = [ Math.round(ele.position().left), Math.round(ele.position().top), Math.round(ele.width()), Math.round(ele.height())];
                coordict[element.id] = thecoords;
                if (frame in window.frame_redactions) {
                    window.frame_redactions[parseInt(frame)][element.id] = thecoords;
                } else {
                    window.frame_redactions[parseInt(frame)] = coordict;
                }
                var box_id = element.id;
                // add markers to modify size 
                // top left marker
                // 6x6 
                var ele = $('#'+element.id);
                // left, top, right, bottom
                $('#video_redaction_table').append('<tr><td style="background:'+element.style.borderColor+'"></td><td></td><td></td><td></td></tr>');
                
                var frame_coordinates = {'left': Math.round(ele.position().left), 'top': Math.round(ele.position().top), 'right': Math.round(ele.position().left + ele.width()), 'bottom': Math.round(ele.position().top + ele.height())};
                setTimeout(addEndPoints, 100, element); // had problem with wrong height so now using timeout and id to use jquery
                //$(this).style.cursor = "default";
                element = null;
                console.log("finsihed.");
                $(this).removeClass('testing');
                $(this).addClass('training');
                $(this).addClass('new_training');
                var coordinates = [];
                $(this).children().each(function() {
                    coordinates.push([$(this).css('top'), $(this).css('left'), $(this).css('width'), $(this).css('height')]);

                });
                //$('#redaction_options').show(); 
                //socket.emit('track_forwards_and_backwards', {'video_id': window.current_video, 'frame': parseInt($('#currentFrame').text()), 'box_id': box_id, 'coordinates': frame_coordinates});
                //$.post('/add_to_training/', {'image': $(this).css('background'), 'coordinates': JSON.stringify(coordinates)});
            } else {
                console.log("begun.");

                console.log(mouse.y);
                mouse.startX = mouse.x;
                mouse.startY = mouse.y;
                element = document.createElement('div');
                element.className = 'rectangle';
                element.id = makeid();
                element.style.left = mouse.x + 'px';
                element.style.top = mouse.y + 'px';
                $(this).append(element)
                window.redaction_n += 1;
                $(element).css('border-color', window.redaction_colors[window.redaction_n]);

                //$(this).style.cursor = "crosshair";
            }
        } else if (mode == 'resize') {
            mode = 'none';
            
            e.stopImmediatePropagation();
            e.stopPropagation();
            var top = parseFloat(element.style.top.slice(0, -2));
            var left = parseFloat(element.style.left.slice(0, -2));
            var width = parseFloat(element.style.width.slice(0, -2));
            var height = $('#' + element.id).height();
            console.log('top: ' + top + ' left: ' + left + ' width: ' + width + ' height: ' + height);
            console.log('color ', element.style.borderColor);
            window.redactionIdToColor[element.id] = element.style.borderColor;
            var color = element.style.borderColor;
            console.log(parseFloat(element.style.left.slice(0, -2)), element.style.left);
            // top left
            $('#top_left_for_' + element.id).css({'top': (top - 3) + 'px', 'left': (left - 3) + 'px'});
            // top right
            $('#top_right_for_' + element.id).css({'top': (top - 3) + 'px', 'left': (left + width - 3) + 'px'});
            // bottom right
            $('#bottom_right_for_' + element.id).css({'top': (top + height - 3) + 'px', 'left': (left + width - 3) + 'px'});
            
            // bottom left
            $('#bottom_left_for_' + element.id).css({'top': (top + height - 3) + 'px', 'left': (left - 3) + 'px'});
            ele = $('#'+element.id);
            var coordict = {};
            var thecoords = [ Math.round(ele.position().left), Math.round(ele.position().top), Math.round(ele.width()), Math.round(ele.height())];
            coordict[element.id] = thecoords;
            if (frame in window.frame_redactions) {
                window.frame_redactions[parseInt(frame)][element.id] = thecoords;
            } else {
                window.frame_redactions[parseInt(frame)] = coordict;
            }
            element = null;
            //$('#'+window.resizeId).css({'
        }
    });
    $('body').keyup(function(e) {
        if (e.keyCode == 32) {
            // user has pressed space
            currentTime = $('#video_player').get(0).currentTime - 1;
            if (window.audio_redaction_state == 'start') {
                window.audio_redaction_state = 'stop';
                var html = '<tr><td><input type="button" value="Play" class="play_audio" /><input type="button" value="Remove" /></td><td class="start"><input type="text" value="' + currentTime + '" /></td><td class="stop"><input type="text" value="" /></td></tr>';
                $('#audio_redaction_table').append(html);
            } else {
                window.audio_redaction_state = 'start';
                $('#audio_redaction_table tr:last-child .stop input').val(currentTime);
            }

            e.preventDefault();
            return false; // even with these pressing space bar = move down
            setTimeout(function() {
                $("body").scrollTop("#video_player")
            }, 1000); // to counter act that ug doesn't work
        }
    });
});
    </script>
    <style>
    body {
  padding-top: 50px;
}
#login_table th {
padding-right:20px;
}
li.right {
float:right;
}
.main {
margin-top:20px;
}
.main-nav {
font-size:.9em;
}
.form th {
padding:0 10px 10px 0;
}
.warning {
color:red;
}
input[type=text] {
width:150px;
}
#video_player_for_manage_videos {
float:right;
border:1px solid #000;
min-width:640px;
min-height:480px;
position:relative;
}
.thumb {
margin:10px 10px 0 0;
background-size:   cover;     
width:160px;
height:120px;
float:left;
}
.rectangle, .finished_rectangle {
    border: 1px solid #FF0000;
    position: absolute;
    opacity: 0.8;
    background:#181818;
}
    #video_player_canvas {
    min-width:640px;
    min-height:450px;
    position:absolute;
    z-index:2;
    
    }
    #video_player {
    position:absolute;
    z-index:1;
    }
    #controls {
    margin-top:480px;
    }
    #audio_redaction_table, #video_redaction_table {
    width:100%;
    }
#redaction_options {
display:none;
background:#000;
color:#FFF;
z-index:3;
position:absolute;
top:0;
left:0;
width:400px;
height:400px;
}
#video_redaction_table th, #video_redaction_table td, #audio_redaction_table th, #audio_redaction_table td {
padding:5px; 
border:1px solid #000;
min-height:20px;
}
.finished_rectangle input {
font-size:.8em;
}
    </style>
</head>
<body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">RedactVideo</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav main-nav">
            
            <li><a href="#upload_videos">Upload videos</a></li>
            <li><a href="#manage_videos">Manage videos</a></li>
            <li><a href="#manage_publication">Manage publication</a></li>
            <li><a href="#do_bulk_over_blur">Do bulk over-blur</a></li>
            <li><a href="#do_precise_redaction">Do precise redaction</a></li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
                {% if is_admin %}
                <li>
                    <a href="#site_settings">
                        <span class="glyphicon glyphicon-cog" id="icon"> Site settings</span>  
                    </a>
                </li>
                {% endif %}
                <li>
                    <a href="#my_account">
                        <span class="glyphicon glyphicon-user" id="icon"> My account</span>  
                    </a>
                </li>
                <li>
                    <a href="/logout/">
                        <span class="glyphicon glyphicon-off" id="icon"> Logout</span>  
                    </a>
                </li>
            </ul> 
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div id="upload_videos_container" class="container main">
    <h2>Upload videos</h2>
    <p><strong>Note:</strong> Videos are converted to the H.264 video format. This way they can be played back in the browser without using Adobe Flash.</p>
      <h3>Upload from your computer</h3>
      <form action="https://{{ upload['bucket_name'] }}.s3-us-west-2.amazonaws.com/" id="dropzone" class="dropzone">
        <input type="hidden" name="key" value="{{ userid }}/${filename}">
        <input type="hidden" name="AWSAccessKeyId" value="{{ upload['access_key_id'] }}">
        <input type="hidden" name="acl" value="public-read">
        <input type="hidden" name="policy" value="{{ upload['policy'] }}">
        <input type="hidden" name="signature" value="{{ upload['signature'] }}">
        <div class="dz-message" data-dz-message><span>Drag videos to this box or click here to upload videos.</span></div>
      </form>
            
    
    <h3>Copy videos from evidence.com to RedactVideo</h3>
    <p>Read page 88 of <a href="http://public.evidence.com/help/pdfs/latest/EVIDENCE.com+Administrator+Reference+Guide.pdf">Evidence.com's reference guide</a> for 
    instructions on sending unauthenticated downloads. Select the audit trail checkbox.</p>
    <h4>Just copy over to RedactVideo</h4>
    <p><strong>Send unauthenticated download link to:</strong> {{ users_random_id }}_just_copy_over@redactvideo.org</p>
    <h4>Upload as is to Youtube</h4>
    <p>For situations where you want to post unredacted videos on Youtube or
    want to do the redaction on Evidence.com but post on Youtube.</p>
    <p><strong>Send unauthenticated download link to:</strong> {{ users_random_id }}_as_is_to_youtube@redactvideo.org</p>
    <h3>Connect RedactVideo to your own Amazon S3 bucket</h3>
    <div id="google_api_settings">
      <table class="form">
      <tr><th>Access key ID:</th><td><input type="text" name="access_key_id" value="{{ user_settings['access_key_id'] }}" /></td></tr>
      <tr><th>Secret access key:</th><td><input type="password" name="secret_access_key" value="{{ user_settings['secret_access_key'] }}" /></td></tr>
      </table>
      <input type="button" class="save_user_settings" value="Save" /> <span></span>
      </div>
    <h3>Copy a video from a url</h3>
    <p>Currently Youtube and Dropbox urls are supported.</p>
    </div>
    
    <div id="manage_videos_container" class="container main">
      <h2>Manage videos</h2>
      <div id="video_player_for_manage_videos">
      
      </div>
      <table id="list_of_videos"><tr><th>Filename</th></tr>
      {% for video in videos %}
      <tr><td><a href="#{{ video['name'] }}" data-hash="{{ video['hash'] }}">{{ video['name'] }}</a></td></tr>
      {% endfor %}
      </table>
      
    </div>
    <div id="manage_publication_container" class="container main">
      <h2>Manage publication</h2>
      <h3>Youtube connection</h3>
      <p>{% if has_authed_with_youtube %}
      <a href="https://accounts.google.com/o/oauth2/auth?
client_id={{ google_client_id }}&approval_prompt=force&access_type=offline&
redirect_uri=http%3A%2F%2Fredactvideo.org%2Fyoutube_oauth_callback%2F&
scope=https://www.googleapis.com/auth/youtube.upload&
response_type=code" target="_blank">Click here</a> to reauthenticate with Youtube.
      {% else %}<a href="https://accounts.google.com/o/oauth2/auth?
client_id={{ google_client_id }}&approval_prompt=force&access_type=offline&
redirect_uri=http%3A%2F%2Fredactvideo.org%2Fyoutube_oauth_callback%2F&
scope=https://www.googleapis.com/auth/youtube.upload&
response_type=code" target="_blank">Click here</a> to authenticate with Youtube.{% endif %}</p>
    </div>
    <div id="do_bulk_over_blur_container" class="container main">
      <h2>Do bulk over-blur</h2>
      <h3>On demand</h3>
      <input type="button" value="Over-blur and publish all videos on this server" id="overblur_and_publish_all_videos" /> <span></span>
      <h3>Automation settings</h3>
      <ul>
      <li><input type="radio" name="over_blur_settings" value="automatically_over_blur_and_publish" /> 
      Automatically over-blur and publish any videos you upload</li>
      <li><input type="radio" name="over_blur_settings" value="automatically_over_blur_but_manually_publish" /> 
      Automatically over-blur but only publish what is manually approved</li>
      </ul>
    </div>
    <div id="do_precise_redaction_container" class="container main">
      <h2>Do precise redaction</h2>
      <h3>Step 1. Upload the video to redact</h3>
      <p>If you have already uploaded the video you want to precisely redact then <a href="#step_two_do_precise_redaction">click here</a>.</p>
    </div>
    <div id="site_settings_container" class="container main">
    {% if is_admin %}
      <h2>Site Settings</h2>
      <h3>S3 settings</h3>
      <div id="s3_settings">
      <table class="form">
      <tr><th>Bucket name:</th><td><input type="text" name="bucket_name" value="{{ site_settings['bucket_name'] }}" /></td></tr>
      <tr><th>Access key ID:</th><td><input type="text" name="access_key_id" value="{{ site_settings['access_key_id'] }}" /></td></tr>
      <tr><th>Secret access key:</th><td><input type="password" name="secret_access_key" value="{{ site_settings['secret_access_key'] }}" /></td></tr>
      </table>
      <input type="button" class="save" value="Save" /> <span></span>
      </div>
      <h3>Google API settings for Youtube</h3>
      <div id="google_api_settings">
      <table class="form">
      <tr><th>Client ID:</th><td><input type="text" name="google_client_id" value="{{ site_settings['google_client_id'] }}" /></td></tr>
      <tr><th>Client secret:</th><td><input type="text" name="google_client_secret" value="{{ site_settings['google_client_secret'] }}" /></td></tr>
      </table>
      <input type="button" class="save" value="Save" /> <span></span>
      </div>
      <h3>SendGrid settings</h3>
      <div id="sendgrid_settings">
      <table class="form">
      <tr><th>Username:</th><td><input type="text" name="sendgrid_username" value="{{ site_settings['sendgrid_username'] }}" /></td></tr>
      <tr><th>Password:</th><td><input type="password" name="sendgrid_password" value="{{ site_settings['sendgrid_password'] }}" /></td></tr>
      </table>
      </div>
      <h3>Auto update settings</h3>
      <div id="autoupdate_settings">
      <table class="form">
      <tr><th>Github secret:</th><td><input type="password" name="github_auto_update_secret" value="{{ site_settings['github_auto_update_secret'] }}" /></td></tr>
      </table>
      <input type="button" class="save" value="Save" /> <span></span>
      </div>
      <h3>Google Analytics</h3>
      <div id="autoupdate_settings">
      <table class="form">
      <tr><th>Google Analytics tracking ID:</th><td><input type="password" name="google_analytics_tracking_id" value="{{ site_settings['google_analytics_tracking_id'] }}" /></td></tr>
      </table>
      <input type="button" class="save" value="Save" /> <span></span>
      </div>
    {% endif %}
    </div>
    <div id="my_account_container" class="container main">
    <h2>My account</h2>
      <h3>Change password</h3>
      <p><strong class="warning">IMPORTANT SECURITY ADVICE:</strong> <ol><li>Make your password significantly different from 
      any you have ever used. Doing so 
      protects this account if another account is compromised.</li>
      <li>
      Use an unguessable password. For example turn a sentence into a password. </li>
      </ol>
      The above advice is from security expert Bruce Schneier at <a href="https://www.schneier.com/blog/archives/2014/03/choosing_secure_1.html" target="_blank">
      Choosing Secure Passwords</a>.
      </p>
    </div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', '{{ google_analytics_tracking_id }}', 'auto');
  ga('send', 'pageview');

</script>    
</body>
</html>
